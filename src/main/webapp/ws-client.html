<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Web Service Client</title>
<link rel="stylesheet" href="jquery-lib/qunit-2.3.3.css">
<link rel="stylesheet" href="helloworld.css">
<script src="jquery-lib/jquery-3.2.1.js"></script>
<script src="jquery-lib/qunit-2.3.3.js"></script>
	<script>
		function valForm(){
			if($.trim($("#tbUser").val())===""){
				alert("Enter user name");
				return false;
			}
			if($.trim($("#tbInput").val())===""){
				alert("Enter message");
				return false;
			}
			if($.trim($("#tbCity").val())===""){
				alert("Enter city");
				return false;
			}
			return true;
		}

		$(document).ready(function(){
			$("#btnSubmit").click(function(){
				if(!valForm()) return false;
				$.post("http://localhost:8080/hello-world/rest/hello-ws/post",
					{
						"user": $("#tbUser").val(),
						"text": $("#tbInput").val(),
						"city": $("#tbCity").val()
					},
					function(data){
						var items = [];
						$.each(data, function(key, val) {
							if(key=="last-msg"){
								$("#divRetDisp").html(val);
							}else{
								items.push("<tr id='" + key + "' onclick='$(\"#"+key+"_rep\").css(\"display\",\"inline\")'><td>" + val.msg +"</td><td>"+val.created+"</td></tr>");
								if(val.rpl==null||val.rpl===undefined){
									items.push("<tr id='" + key + "_rep' style='display:none'><td colspan='2' style='padding-left:35px' id='td_"+key+"'><input id='tbRep_"+key+"' type='text'/></td></tr>");
								}else{
									items.push("<tr id='" + key + "_rep' style='display:inline'><td colspan='2' style='padding-left:35px' id='td_"+key+"'>"+val.rpl+"</td></tr>");
								}
							}
						});

						$("#divMsgs").html("<table id='tblMsgs'><tr><th>Message</th><th>Created</th></tr>"+items.join("")+"</table>");

						$.each(data, function(key, val) {
							if(key!="last-msg"&&(val.rpl==null||val.rpl===undefined)){
								$("<input/>",{type: "button", 
									id: "btnRep_"+key,
									val:"Reply", 
									"height": "25px",
									"css": {"background-color" : "#4286f4", "color" : "#d1e2ff"},
									click: function(){
										$.post("http://localhost:8080/hello-world/rest/hello-ws/postrpl",
										{
											"user": $("#tbUser").val(),
											"msgid": key,
											"rpl": $("#tbRep_"+key).val()
										},
										function(data){
											if(data){
												$("#td_"+key).html($("#tbRep_"+key).val());
											}else{
												alert("Something went wrong on the server side - please try again and if the problem persists notify support team");
											}
										});
									}
								}).appendTo($("#td_"+key));
							}
						});
					}					
				);
			});
		});		
	</script>
	
	<!-- QUnit tests -->
	<script>
		$(document).ready(function(){
			var testTxt = "TeSt String";
			var testUsr = "tester";
			var testCity = "Toronto";
			
			$("#tbInput").val(testTxt);
			$("#tbUser").val(testUsr);
			$("#tbCity").val(testCity);
			
			$("#btnSubmit").trigger("click");
	
			QUnit.test("Unit Test for client page", function(assert){
		        var done = assert.async(5);
		        
		        //Positive test case
		        setTimeout(function() {
		        	assert.equal(testTxt, $("#divRetDisp").html(), "Text should be the same" );
		           done();
		        }, 500);
		        
		        setTimeout(function() {
		        	assert.equal(testUsr, $("#tbUser").val(), "User shoud remain unchanged" );
		           done();
		        }, 500);

				// There should be at least one row: the one used in this test + header = at least 2
		        setTimeout(function() {
		        	assert.notEqual(1, $("#tblMsgs tr").length, "Mesages are not empty" );
		           done();
		        }, 500);

		        //Negative test case
		        setTimeout(function() {
		        	assert.notEqual("some other text", $("#divRetDisp").html(), "Text to compare is different" );
		           done();
		        }, 500);

				// Reply text test
		        setTimeout(function() {
		        	assert.equal("test rpl", $("#td_1").html(), "Reply to first test message is known" );
		           done();
		        }, 500);				
	        });			
		});

	</script>
</head>
<body>
	<table cellpadding="2">
		<tr>
			<td align="right">Username:</td>
			<td><input type="text" id="tbUser"></td>
			<td align="right">City:</td>
			<td><input type="text" id="tbCity"></td>			
		</tr><tr>
			<td align="right">Text:</td>
			<td><input type="text" id="tbInput"/></td>
			<td><button id="btnSubmit" colspan="2">Done</button></td>
		</tr><tr>
			<td colspan="3"><div id="divRetDisp"></div></td>
		</tr>
	</table><br><br><br>
	<div id="divMsgs" class="hw-div"></div>

	<!-- Unit Test-->
	<div id="qunit-section">
		<h3>QUnit section:</h3>
		<div id="qunit"></div>
		<div id="qunit-fixture"></div>
	</div>

</body>
</html>